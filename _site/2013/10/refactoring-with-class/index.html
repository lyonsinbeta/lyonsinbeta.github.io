<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Refactoring with Class |  Lyons In Beta</title>
    <meta name="description" content="The blog of David Lyons" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />


    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
</head>
<body class="home-template">


    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/">
                
                    <span class="blog-title">Lyons In Beta</span>
                 
            </a>
        </header>
        
        <span class="post-meta">
        	<time datetime="2013-10-28">28 Oct 2013</time>
       	</span>

        <h1 class="post-title">Refactoring with Class</h1>

        <section class="post-content">
            <p>If you ever want to know if you&#39;re making progress on a skill, go back and look at your earlier work compared to your recent stuff. I was reviewing some of my old scripts on Github and I was surprised how simple and linear they are. They got the job done, but only just barely...</p>

<!--more-->

<p>Now I&#39;m not a full time coder, so I haven&#39;t exactly gone pro since then, but I have moved from the ultra simple scripts of yore, to more intelligently formatted and reusable code.</p>

<p>Oh and classes, classes are cool.</p>

<p>Let&#39;s look at a script I wrote not that long ago. It concatenates some CSV files together and gets them into the format I need them.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;csv&#39;

courses = &quot;courses.csv&quot;

altered = []

CSV.foreach(courses, { :headers =&gt; true, :header_converters =&gt; :symbol }) do |course|
  altered &lt;&lt; course.headers unless altered.size &gt; 0
  course[:start_date] += &quot;T01:00:01-6:00&quot; unless course[:start_date].match(/T\d\d:\d\d:\d\d-/)
  course[:end_date] += &quot;T22:59:59-6:00&quot; unless course[:end_date].match(/T\d\d:\d\d:\d\d-/)
  altered &lt;&lt; course
end

CSV.open(courses, &quot;w+&quot;) do |csv|
  altered.each do |row|
    csv &lt;&lt; row
  end
end

teachers = &quot;enrollments_t.csv&quot;
students = &quot;enrollments.csv&quot;

CSV.open(students, &quot;a&quot;) do |csv|
  CSV.foreach(teachers, { :headers =&gt; true, :header_converters =&gt; :symbol }) do |teacher|
    csv &lt;&lt; teacher
  end
end

sections = &quot;sections.csv&quot;

altered = []

CSV.foreach(sections, { :headers =&gt; true, :header_converters =&gt; :symbol }) do |section|
  altered &lt;&lt; section.headers unless altered.size &gt; 0
  section[:start_date] = &quot;&quot;
  section[:end_date] = &quot;&quot;
  altered &lt;&lt; section
end

CSV.open(sections, &quot;w+&quot;) do |csv|
  altered.each do |row|
    csv &lt;&lt; row
  end
end

teachers = &quot;users_t.csv&quot;
students = &quot;users.csv&quot;

CSV.open(students, &quot;a&quot;) do |csv|
  CSV.foreach(teachers, { :headers =&gt; true, :header_converters =&gt; :symbol }) do |teacher|
    csv &lt;&lt; teacher
  end
end
</code></pre></div>
<p>Oh the horror. It does the job, but it has a lot of smells (and probably more then I even realize.) The most obvious is the duplication. Second (but related) is the <em>complete</em> lack of functions; if I need to concatenate more than just the four files I&#39;d have to extend the script each time. Next is the most up to date version.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;csv&#39;

FILE_TYPES = [&quot;courses&quot;, &quot;sections&quot;, &quot;users&quot;, &quot;enrollments&quot;]

class CSVFixer

  attr_reader :rows

  def initialize(csvs_name)
    @csvs, @rows = [], []
    @csvs_name   = csvs_name
    @csvs        = get_csvs
    read_csvs(@csvs)
  end

  def get_csvs
    @csvs = Dir.glob(&quot;csvs/*#{@csvs_name}*&quot;, File::FNM_CASEFOLD)
  end

  def read_csvs(csvs)
    csvs.each do |csv|
      CSV.foreach(csv, { :headers           =&gt; true, 
                         :header_converters =&gt; :symbol, 
                         :encoding          =&gt; &quot;windows-1251:utf-8&quot; }) do |row|
        @rows &lt;&lt; row
      end
    end
  end

  def write_csvs(folder, file_name)
    CSV.open(&quot;#{folder}/#{file_name}.csv&quot;, &quot;w&quot;, 
             :write_headers =&gt; true, :headers =&gt; @rows[0].headers) do |csv|
      @rows.each do |row|
        remove_section_dates(row) if file_name == &quot;sections&quot;
        extend_course_end_date(row) if file_name == &quot;courses&quot; &amp;&amp; row[:end_date] == &quot;2013-12-14&quot;
        csv &lt;&lt; row
      end
    end
  end

  def remove_section_dates(row)
    row[:start_date] = &quot;&quot;
    row[:end_date]   = &quot;&quot;
  end

  def extend_course_end_date(row)
    # Horrible magic number change for Fall 2013
    row[:end_date] = &quot;2013-12-25&quot;
  end
end

def make_folder
  folder_name = Time.now.strftime(&quot;%Y-%m-%d %H%M%S&quot;)
  while File.exists?(folder_name)
    sleep 1
    folder_name = Time.now.strftime(&quot;%Y-%m-%d %H%M%S&quot;)
  end

  Dir::mkdir(folder_name)

  return folder_name
end

output = make_folder

FILE_TYPES.each do |type|
  fix = CSVFixer.new(type)
  next if fix.rows.empty?
  fix.write_csvs(output, type)
  puts &quot;Processed #{fix.rows.length} rows for #{type}.csv&quot;
end
</code></pre></div>
<p>So this version is 20 lines longer, but it adds so much goodness in those 20 lines. First, a class is used to declare and make accessible the commonly needed functions, and a CONSTANT holds the names of files (that are now DIR::glob-ed for). This means that I can now make the entire tool also process groups.csv but just adding <code>&quot;groups&quot;</code> to the <code>FILE_TYPES</code> array. I can also concatenate any number of partial files, so if I have users.csv, users1.csv, users2.csv <strong>and</strong> users3.csv, it will read in all the lines and cram them into one (UTF-8!!) file.</p>

<p>This little tool still isn&#39;t perfect. It assumes the files are formatted correctly (they come from a machine source so that&#39;s fairly likely) and it does use a magic number, but all in all it&#39;s infinitely more extensible and reusable the the original iteration.</p>

<p>The time I spent writing this little utility didn&#39;t just save me many hours of boring (and error prone) manual concatenation of files, but my coworkers got to benefit from using it while I was away from the office.</p>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            
                <section class="author">
                	<header> <a href="/"> <img class="profile" src="/assets/images/profile.png" alt="Author's profile picture"></a></header>
                	<article>
                		<!-- Author Name -->
                    	<h4> David Lyons </h4>
                    	<!-- Author Bio -->
                    	<p> 
                    	Lover of technology, practitioner of Kung fu, and devourer of Korean food. Follow me on <a href="//twitter.com/lyonsinbeta">twitter</a> and <a href="//plus.google.com/+DavidLyons?rel=author">Google+</a>
                      </p>
                    </article>
                </section>                
            

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Refactoring with Class&amp;url=http://lyonsinbeta.com/2013/10/refactoring-with-class/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://lyonsinbeta.com/2013/10/refactoring-with-class/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://lyonsinbeta.com/2013/10/refactoring-with-class/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
             <section class="copyright">All content copyright <a href="/">David Lyons</a> &copy;  &bull; All rights reserved.</section>
             <section class="poweredby">Made with Jekyll using <a href="http://github.com/rosario/kasper">Kasper theme</a> and hosted on <a href="http://pages.github.com/">GitHub Pages</a></section>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-44733266-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
